#!/usr/bin/env node

const path = require('path');
const argv = require('minimist')(process.argv.slice(2), {
  alias: {
    verbose: 'v',
    help: 'h',
  },
  boolean: ['verbose', 'help', 'json'],
  default: {
    json: false,
    openapi: false,
    verbose: false,
    help: false,
    timeout: 5000,
  }
})

const HTTPConsole = require('../lib/http-console');
const OpenAPICompleter = require('../lib/completers/openapi.js')
const HistoryCompleter = require('../lib/completers/history.js')

const help = [
  'usage: http-console [protocol://][username:password@][host]:port [options]',
  '',
  'options:',
  '-v, --verbose      be more verbose',
  '    --json         set "Content-Type" header to application/json',
  '    --notimeout    don\'t timeout requests',
  '-c, --config       config file, executed on startup',
  '    --version      print version',
  '    --openapi      enable OpenAPI autocompletion',
  '-h, --help         display this message'
].join('\n');

let options = {
  json:            argv.json,
  timeout:         argv.timeout,
  verbose:         argv.verbose,
  completers:      [ new HistoryCompleter() ]
};

if (typeof process.env.NO_COLOR !== 'undefined') options.colors = false

if (argv.version) {
  console.log('http-console v' + httpConsole.version);
  process.exit(0);
}

if (argv.openapi) {
  options.completers.push(new OpenAPICompleter({
    specEndpoints: typeof argv.openapi === 'string' ? argv.openapi : undefined
  }))
}

if (argv.help) {
  console.log(help)
  process.exit(0);
}

const url = argv._.shift()
if (!url) {
  console.log(help)
  process.exit(1)
}

const c = new HTTPConsole({
  baseUrl: url,
  ...options
})
c.start()
